<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FACTCHECK - Daily Puzzle</title>
    <style>
        @font-face {
            font-family: 'Martius';
            src: url('Martius-LV9L4.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #008080;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 15px 10px;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            min-width: 320px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .game-title {
            font-size: 96px;
            font-weight: 900;
            color: #000080;
            margin-bottom: 5px;
            letter-spacing: -2px;
            font-family: 'Martius', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            line-height: 1;
            text-shadow: 2px 2px 0px #ffffff;
        }
        
        .subtitle {
            font-size: 16px;
            color: #ffffff;
            text-shadow: 1px 1px 0px #000000;
        }
        
        .instructions {
            background: #c0c0c0;
            border-top: 2px solid #ffffff;
            border-left: 2px solid #ffffff;
            border-right: 2px solid #000000;
            border-bottom: 2px solid #000000;
            padding: 15px 20px;
            margin: 15px auto;
            max-width: 800px;
            text-align: left;
            font-size: 14px;
            line-height: 1.6;
            color: #000000;
        }
        
        .instructions strong {
            color: #000080;
        }
        
        .instructions ul {
            margin: 10px 0 0 20px;
            padding: 0;
        }
        
        .instructions li {
            margin: 5px 0;
        }
        
        .game-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 20px;
            align-items: start;
        }
        
        /* LEFT COLUMN - Fact Cards */
        .left-column {
            display: flex;
            flex-direction: column;
            min-width: 0;
            gap: 10px;
        }
        
        .documents-pile {
            display: contents;
        }
        
        .pile-header {
            display: none;
        }
        
        .documents-grid {
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-height: 100px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            cursor: pointer;
        }
        
        .documents-grid:empty::before {
            content: 'Click a card in a slot to return it here';
            color: #ffffff;
            text-align: center;
            font-size: 12px;
            opacity: 0.7;
            padding: 20px;
        }
        
        .left-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }
        
        .checks-display {
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: center;
            background: #c0c0c0;
            padding: 8px 12px;
            border-top: 2px solid #808080;
            border-left: 2px solid #808080;
            border-right: 2px solid #dfdfdf;
            border-bottom: 2px solid #dfdfdf;
        }
        
        .check-icon {
            font-size: 24px;
            transition: opacity 0.3s;
            color: #000000;
        }
        
        .check-icon.used {
            opacity: 0.2;
        }
        
        .button-row {
            display: flex;
            gap: 10px;
        }
        
        .document {
            background: #ffffff;
            border-top: 2px solid #dfdfdf;
            border-left: 2px solid #dfdfdf;
            border-right: 2px solid #808080;
            border-bottom: 2px solid #808080;
            padding: 10px 8px;
            cursor: move;
            font-size: 13px;
            text-align: center;
            box-shadow: none;
            min-height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: none;
            touch-action: none;
            user-select: none;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            line-height: 1.3;
            font-weight: 700;
            color: #000000;
            max-width: 100%;
            position: relative;
        }
        
        .document:hover {
            transform: none;
            box-shadow: none;
        }
        
        .document.dragging {
            opacity: 0.5;
        }
        
        .document.selected {
            border: 3px solid #ff0000;
            background: #ffff00;
        }
        
        .document.in-slot {
            padding-right: 24px;
        }
        
        .remove-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 18px;
            height: 18px;
            background: #ff0000;
            color: #ffffff;
            border: 1px solid #000000;
            border-radius: 0;
            font-size: 12px;
            line-height: 16px;
            font-weight: 700;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 0;
        }
        
        .remove-btn:hover {
            background: #cc0000;
        }
        
        .document.in-slot .remove-btn {
            display: flex;
        }
        
        /* RIGHT COLUMN - Subject Frames */
        .right-column {
            display: flex;
            flex-direction: column;
            gap: 15px;
            min-width: 0;
        }
        
        .subject-frame {
            background: #0000aa;
            border-top: 2px solid #ffffff;
            border-left: 2px solid #ffffff;
            border-right: 2px solid #000000;
            border-bottom: 2px solid #000000;
            padding: 0;
            box-shadow: none;
            width: 100%;
        }
        
        .subject-header {
            background: #0000aa;
            padding: 15px;
            font-size: 28px;
            font-weight: 900;
            text-align: center;
            color: #ffffff;
            letter-spacing: 2px;
            font-family: 'Martius', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            line-height: 1.3;
            word-wrap: break-word;
            overflow-wrap: break-word;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .subject-body {
            background: #c0c0c0;
            padding: 15px;
        }
        
        .subject-slots {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .slot {
            background: #ffffff;
            border-top: 2px solid #808080;
            border-left: 2px solid #808080;
            border-right: 2px solid #dfdfdf;
            border-bottom: 2px solid #dfdfdf;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #808080;
            font-size: 12px;
            transition: all 0.2s;
            padding: 5px;
            cursor: pointer;
        }
        
        .slot.drag-over {
            background: #ffff00;
            border: 2px solid #000000;
        }
        
        .slot.filled {
            background: transparent;
            border: none;
            padding: 0;
        }
        
        .slot .document {
            width: 100%;
            margin: 0;
        }
        
        .subject-status {
            margin-top: 10px;
            padding: 8px;
            background: #ffffff;
            border-top: 2px solid #dfdfdf;
            border-left: 2px solid #dfdfdf;
            border-right: 2px solid #808080;
            border-bottom: 2px solid #808080;
            text-align: center;
            font-size: 14px;
            font-weight: 700;
            display: none;
            color: #000000;
        }
        
        .subject-status.show {
            display: block;
        }
        
        .subject-status.correct {
            background: #00ff00;
            color: #000000;
        }
        
        /* Controls */
        .btn {
            font-family: inherit;
            font-size: 16px;
            font-weight: 700;
            padding: 12px 32px;
            background: #c0c0c0;
            color: #000000;
            border-top: 2px solid #ffffff;
            border-left: 2px solid #ffffff;
            border-right: 2px solid #000000;
            border-bottom: 2px solid #000000;
            cursor: pointer;
            transition: none;
            flex: 1;
        }
        
        .btn:hover {
            background: #dfdfdf;
            transform: none;
        }
        
        .btn:active {
            border-top: 2px solid #000000;
            border-left: 2px solid #000000;
            border-right: 2px solid #ffffff;
            border-bottom: 2px solid #ffffff;
        }
        
        .btn-primary {
            background: #0000aa;
            color: #ffffff;
        }
        
        .btn-primary:hover {
            background: #0000cc;
        }
        
        .result-box {
            background: #c0c0c0;
            border-top: 2px solid #ffffff;
            border-left: 2px solid #ffffff;
            border-right: 2px solid #000000;
            border-bottom: 2px solid #000000;
            padding: 30px;
            margin-top: 30px;
            text-align: center;
            display: none;
        }
        
        .result-box.show {
            display: block;
        }
        
        .result-box.victory {
            background: #00ff00;
        }
        
        .score {
            font-size: 32px;
            font-weight: 700;
            color: #000000;
            margin-bottom: 10px;
        }
        
        .btn-reveal {
            background: #ff0000;
            color: #ffffff;
            margin-top: 15px;
        }
        
        .btn-reveal:hover {
            background: #cc0000;
        }
        
        /* Confetti Animation */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: #ff0000;
            position: absolute;
            animation: confetti-fall 3s linear forwards;
            z-index: 10000;
        }
        
        @keyframes confetti-fall {
            to {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }
        
        .confetti:nth-child(2n) { background: #00ff00; }
        .confetti:nth-child(3n) { background: #0000ff; }
        .confetti:nth-child(4n) { background: #ffff00; }
        .confetti:nth-child(5n) { background: #ff00ff; }
        .confetti:nth-child(6n) { background: #00ffff; }
        .confetti:nth-child(7n) { background: #ffffff; }
        
        .debug-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #c0c0c0;
            color: #000000;
            border-top: 2px solid #ffffff;
            border-left: 2px solid #ffffff;
            border-right: 2px solid #000000;
            border-bottom: 2px solid #000000;
            padding: 8px 12px;
            font-size: 20px;
            font-weight: 700;
            cursor: pointer;
            z-index: 10000;
            line-height: 1;
        }
        
        .debug-btn:hover {
            background: #dfdfdf;
        }
        
        /* Mobile responsive - keep two columns! */
        @media (max-width: 768px) {
            .game-area {
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }
            
            .game-title {
                font-size: 48px;
            }
            
            .subject-header {
                font-size: 20px;
                padding: 10px 8px;
                min-height: 50px;
                letter-spacing: 1px;
            }
            
            .document {
                font-size: 11px;
                padding: 8px 6px;
                min-height: 40px;
            }
            
            .slot {
                min-height: 40px;
                font-size: 10px;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            .game-area {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }
            
            .game-title {
                font-size: 36px;
            }
            
            .subject-header {
                font-size: 16px;
                padding: 8px 5px;
                letter-spacing: 0.5px;
            }
            
            .document {
                font-size: 10px;
                padding: 6px 4px;
                min-height: 35px;
            }
            
            .slot {
                min-height: 35px;
                font-size: 9px;
                padding: 3px;
            }
            
            .subject-body {
                padding: 8px;
            }
            
            .subject-slots {
                gap: 6px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="game-title">FACTCHECK</div>
            <div class="subtitle">Sort the facts into their correct subject groups</div>
        </div>
        
        <div class="instructions">
            <strong>ü§î HERE'S THE TWIST:</strong> You can see the categories, but they're scrambled! 
            <ul>
                <li>üëÜ <strong>Click a fact</strong> to select it (it'll turn yellow)</li>
                <li>üìç <strong>Click a slot</strong> to place it there</li>
                <li>‚ùå <strong>Click the √ó button</strong> or the card itself to remove it</li>
                <li>‚úÖ <strong>Hit CHECK</strong> to see if you're right (you get 5 tries!)</li>
                <li>üî§ Each check reveals more letters...</li>
            </ul>
        </div>
        
        <div class="game-area">
            <!-- LEFT COLUMN: Fact Cards -->
            <div class="left-column">
                <div class="documents-pile">
                    <div class="pile-header">Facts to Sort</div>
                    <div class="documents-grid" id="documentsPile">
                        <!-- Facts will be added here by JavaScript -->
                    </div>
                </div>
                
                <div class="left-controls">
                    <div class="checks-display">
                        <span class="check-icon">‚úì</span>
                        <span class="check-icon">‚úì</span>
                        <span class="check-icon">‚úì</span>
                        <span class="check-icon">‚úì</span>
                        <span class="check-icon">‚úì</span>
                    </div>
                    <div class="button-row">
                        <button class="btn btn-primary" id="checkBtn">CHECK</button>
                        <button class="btn" id="resetBtn">RESET</button>
                    </div>
                </div>
            </div>
            
            <!-- RIGHT COLUMN: Subject Frames -->
            <div class="right-column" id="subjectFrames">
                <!-- Subject frames will be added here by JavaScript -->
            </div>
        </div>
        
        <div class="result-box" id="resultBox">
            <div id="resultText"></div>
        </div>
    </div>
    
    <button class="debug-btn" id="debugCycle">‚Üí</button>
    
    <script>
        // Puzzle data structure: 3 subjects, each with 3 facts (9 total)
        const puzzles = [
            {
                subjects: [
                    {
                        name: "HONEY",
                        facts: [
                            { text: "NEVER SPOILS", answer: 0 },
                            { text: "MADE BY BEES", answer: 0 },
                            { text: "FOUND IN PYRAMIDS", answer: 0 }
                        ]
                    },
                    {
                        name: "LEGO BRICKS",
                        facts: [
                            { text: "PLASTIC MATERIAL", answer: 1 },
                            { text: "INTERLOCKING PIECES", answer: 1 },
                            { text: "MADE IN DENMARK", answer: 1 }
                        ]
                    },
                    {
                        name: "MAPLE SYRUP",
                        facts: [
                            { text: "FROM TREE SAP", answer: 2 },
                            { text: "BOILED TO THICKEN", answer: 2 },
                            { text: "SWEET PANCAKE TOPPING", answer: 2 }
                        ]
                    }
                ]
            },
            {
                subjects: [
                    {
                        name: "DOLPHINS",
                        facts: [
                            { text: "ARE MAMMALS", answer: 0 },
                            { text: "HAVE BLOWHOLE", answer: 0 },
                            { text: "USE ECHOLOCATION", answer: 0 }
                        ]
                    },
                    {
                        name: "SHARKS",
                        facts: [
                            { text: "ARE FISH", answer: 1 },
                            { text: "HAVE GILLS", answer: 1 },
                            { text: "CARTILAGE SKELETON", answer: 1 }
                        ]
                    },
                    {
                        name: "JELLYFISH",
                        facts: [
                            { text: "CAN STING", answer: 2 },
                            { text: "MOSTLY WATER", answer: 2 },
                            { text: "TRANSPARENT BODY", answer: 2 }
                        ]
                    }
                ]
            },
            {
                subjects: [
                    {
                        name: "GUITAR",
                        facts: [
                            { text: "HAS FRETS", answer: 0 },
                            { text: "PLUCKED STRINGS", answer: 0 },
                            { text: "USUALLY PORTABLE", answer: 0 }
                        ]
                    },
                    {
                        name: "PIANO",
                        facts: [
                            { text: "HAS HAMMERS", answer: 1 },
                            { text: "HAS 88 KEYS", answer: 1 },
                            { text: "EXTREMELY HEAVY", answer: 1 }
                        ]
                    },
                    {
                        name: "DRUMS",
                        facts: [
                            { text: "HIT WITH STICKS", answer: 2 },
                            { text: "PERCUSSION INSTRUMENT", answer: 2 },
                            { text: "KEEPS THE BEAT", answer: 2 }
                        ]
                    }
                ]
            },
            {
                subjects: [
                    {
                        name: "OCTOPUS",
                        facts: [
                            { text: "HAS THREE HEARTS", answer: 0 },
                            { text: "BLUE BLOOD", answer: 0 },
                            { text: "CAN CHANGE COLOR", answer: 0 }
                        ]
                    },
                    {
                        name: "GIRAFFE",
                        facts: [
                            { text: "TALLEST ANIMAL", answer: 1 },
                            { text: "SAME NECK BONES AS HUMAN", answer: 1 },
                            { text: "PURPLE TONGUE", answer: 1 }
                        ]
                    },
                    {
                        name: "PLATYPUS",
                        facts: [
                            { text: "LAYS EGGS", answer: 2 },
                            { text: "HAS VENOMOUS SPURS", answer: 2 },
                            { text: "SWEATS MILK", answer: 2 }
                        ]
                    }
                ]
            },
            {
                subjects: [
                    {
                        name: "VENUS",
                        facts: [
                            { text: "HOTTEST PLANET", answer: 0 },
                            { text: "SPINS BACKWARDS", answer: 0 },
                            { text: "DAY LONGER THAN YEAR", answer: 0 }
                        ]
                    },
                    {
                        name: "SATURN",
                        facts: [
                            { text: "HAS VISIBLE RINGS", answer: 1 },
                            { text: "FLOATS IN WATER", answer: 1 },
                            { text: "62 KNOWN MOONS", answer: 1 }
                        ]
                    },
                    {
                        name: "NEPTUNE",
                        facts: [
                            { text: "FASTEST WINDS", answer: 2 },
                            { text: "RAINS DIAMONDS", answer: 2 },
                            { text: "BLUE FROM METHANE", answer: 2 }
                        ]
                    }
                ]
            },
            {
                subjects: [
                    {
                        name: "TOMATO",
                        facts: [
                            { text: "TECHNICALLY A FRUIT", answer: 0 },
                            { text: "95% WATER", answer: 0 },
                            { text: "MORE GENES THAN HUMANS", answer: 0 }
                        ]
                    },
                    {
                        name: "BANANA",
                        facts: [
                            { text: "BERRIES BOTANICALLY", answer: 1 },
                            { text: "NATURALLY RADIOACTIVE", answer: 1 },
                            { text: "CURVED FROM SUN", answer: 1 }
                        ]
                    },
                    {
                        name: "PEANUT",
                        facts: [
                            { text: "GROWS UNDERGROUND", answer: 2 },
                            { text: "NOT A NUT", answer: 2 },
                            { text: "MAKES DYNAMITE", answer: 2 }
                        ]
                    }
                ]
            },
            {
                subjects: [
                    {
                        name: "EIFFEL TOWER",
                        facts: [
                            { text: "GROWS IN SUMMER", answer: 0 },
                            { text: "REPAINTED EVERY 7 YEARS", answer: 0 },
                            { text: "WAS TEMPORARY", answer: 0 }
                        ]
                    },
                    {
                        name: "GREAT WALL",
                        facts: [
                            { text: "NOT VISIBLE FROM SPACE", answer: 1 },
                            { text: "USED STICKY RICE", answer: 1 },
                            { text: "13000 MILES LONG", answer: 1 }
                        ]
                    },
                    {
                        name: "STATUE LIBERTY",
                        facts: [
                            { text: "GIFT FROM FRANCE", answer: 2 },
                            { text: "USED TO BE SHINY", answer: 2 },
                            { text: "LIGHTHOUSE BRIEFLY", answer: 2 }
                        ]
                    }
                ]
            },
            {
                subjects: [
                    {
                        name: "CROWS",
                        facts: [
                            { text: "HOLD GRUDGES", answer: 0 },
                            { text: "MAKE TOOLS", answer: 0 },
                            { text: "RECOGNIZE FACES", answer: 0 }
                        ]
                    },
                    {
                        name: "PIGEONS",
                        facts: [
                            { text: "SEE UV LIGHT", answer: 1 },
                            { text: "CAN DO MATH", answer: 1 },
                            { text: "WAR HEROES", answer: 1 }
                        ]
                    },
                    {
                        name: "PARROTS",
                        facts: [
                            { text: "NAME THEIR BABIES", answer: 2 },
                            { text: "LIVE 80 YEARS", answer: 2 },
                            { text: "LAUGH AT JOKES", answer: 2 }
                        ]
                    }
                ]
            },
            {
                subjects: [
                    {
                        name: "COCA COLA",
                        facts: [
                            { text: "ORIGINALLY HAD COCAINE", answer: 0 },
                            { text: "OWNED SANTA IMAGE", answer: 0 },
                            { text: "DISSOLVES TEETH", answer: 0 }
                        ]
                    },
                    {
                        name: "PEPSI",
                        facts: [
                            { text: "NAMED AFTER ENZYME", answer: 1 },
                            { text: "HAD 6TH LARGEST NAVY", answer: 1 },
                            { text: "SOLD AS MEDICINE", answer: 1 }
                        ]
                    },
                    {
                        name: "DR PEPPER",
                        facts: [
                            { text: "OLDEST SODA", answer: 2 },
                            { text: "NO PERIOD IN NAME", answer: 2 },
                            { text: "23 FLAVORS", answer: 2 }
                        ]
                    }
                ]
            },
            {
                subjects: [
                    {
                        name: "CLEOPATRA",
                        facts: [
                            { text: "CLOSER TO IPHONE", answer: 0 },
                            { text: "SPOKE 9 LANGUAGES", answer: 0 },
                            { text: "NOT EGYPTIAN", answer: 0 }
                        ]
                    },
                    {
                        name: "NAPOLEON",
                        facts: [
                            { text: "ATTACKED BY RABBITS", answer: 1 },
                            { text: "NOT ACTUALLY SHORT", answer: 1 },
                            { text: "WROTE ROMANCE NOVEL", answer: 1 }
                        ]
                    },
                    {
                        name: "EINSTEIN",
                        facts: [
                            { text: "FAILED MATH MYTH", answer: 2 },
                            { text: "COULD HAVE BEEN PRESIDENT", answer: 2 },
                            { text: "BRAIN WAS STOLEN", answer: 2 }
                        ]
                    }
                ]
            },
            {
                subjects: [
                    {
                        name: "GOLD",
                        facts: [
                            { text: "EDIBLE METAL", answer: 0 },
                            { text: "CAME FROM SPACE", answer: 0 },
                            { text: "NEVER RUSTS", answer: 0 }
                        ]
                    },
                    {
                        name: "DIAMONDS",
                        facts: [
                            { text: "BURNS IN FIRE", answer: 1 },
                            { text: "RAINS ON SATURN", answer: 1 },
                            { text: "MADE FROM CARBON", answer: 1 }
                        ]
                    },
                    {
                        name: "PEARLS",
                        facts: [
                            { text: "DISSOLVE IN VINEGAR", answer: 2 },
                            { text: "OYSTER IMMUNE RESPONSE", answer: 2 },
                            { text: "ONLY GEM FROM LIFE", answer: 2 }
                        ]
                    }
                ]
            },
            {
                subjects: [
                    {
                        name: "TYRANNOSAURUS",
                        facts: [
                            { text: "ARMS TOO SHORT", answer: 0 },
                            { text: "CLOSEST TO CHICKENS", answer: 0 },
                            { text: "LIVED WITH FLOWERS", answer: 0 }
                        ]
                    },
                    {
                        name: "STEGOSAURUS",
                        facts: [
                            { text: "BRAIN SIZE OF WALNUT", answer: 1 },
                            { text: "PLATES FOR DISPLAY", answer: 1 },
                            { text: "TAIL SPIKES CALLED THAGOMIZER", answer: 1 }
                        ]
                    },
                    {
                        name: "VELOCIRAPTOR",
                        facts: [
                            { text: "TURKEY SIZED", answer: 2 },
                            { text: "HAD FEATHERS", answer: 2 },
                            { text: "JURASSIC PARK LIED", answer: 2 }
                        ]
                    }
                ]
            }
        ];
        
        let currentPuzzle = null;
        let currentPuzzleIndex = 0;
        let checksRemaining = 5;
        let revealProgress = 0;
        let draggedElement = null;
        let touchClone = null;
        let selectedCard = null; // For mobile click/tap selection
        
        // Initialize game
        function initGame(puzzleIndex = null) {
            if (puzzleIndex !== null) {
                currentPuzzleIndex = puzzleIndex;
            } else {
                const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / 86400000);
                currentPuzzleIndex = dayOfYear % puzzles.length;
            }
            
            currentPuzzle = puzzles[currentPuzzleIndex];
            checksRemaining = 5;
            revealProgress = 0;
            
            // Reset check icons
            document.querySelectorAll('.check-icon').forEach(icon => {
                icon.classList.remove('used');
            });
            
            // Create subject frames
            createSubjectFrames();
            
            // Collect all facts and shuffle
            const allFacts = [];
            currentPuzzle.subjects.forEach((subject, subjectIndex) => {
                subject.facts.forEach(fact => {
                    allFacts.push({
                        text: fact.text,
                        answer: fact.answer,
                        subjectIndex: subjectIndex
                    });
                });
            });
            
            // Shuffle facts
            const shuffledFacts = allFacts.sort(() => Math.random() - 0.5);
            
            // Add facts to pile
            const pile = document.getElementById('documentsPile');
            pile.innerHTML = '';
            shuffledFacts.forEach((fact, index) => {
                const doc = createDocument(fact.text, fact.answer, index);
                pile.appendChild(doc);
            });
            
            // Hide result box
            document.getElementById('resultBox').classList.remove('show');
        }
        
        function createSubjectFrames() {
            const container = document.getElementById('subjectFrames');
            container.innerHTML = '';
            
            // Group subjects by letter count first to determine hints
            const subjectsByLength = {};
            currentPuzzle.subjects.forEach((subject, index) => {
                const length = subject.name.replace(/ /g, '').length;
                if (!subjectsByLength[length]) {
                    subjectsByLength[length] = [];
                }
                subjectsByLength[length].push({ subject, index });
            });
            
            // Calculate hint positions
            const hintPositions = {};
            Object.values(subjectsByLength).forEach(group => {
                if (group.length >= 2) {
                    for (let i = 0; i < group.length; i++) {
                        for (let j = i + 1; j < group.length; j++) {
                            const diffPos = findDifferentiatingPosition(
                                group[i].subject.name,
                                group[j].subject.name
                            );
                            hintPositions[group[i].index] = diffPos;
                            hintPositions[group[j].index] = diffPos;
                        }
                    }
                }
            });
            
            currentPuzzle.subjects.forEach((subject, index) => {
                const frame = document.createElement('div');
                frame.className = 'subject-frame';
                frame.dataset.subjectIndex = index;
                
                // Scramble the subject name with hint if applicable
                const hintPos = hintPositions[index];
                const scrambledName = hintPos !== undefined 
                    ? scrambleTextWithHint(subject.name, revealProgress / 5, hintPos)
                    : scrambleText(subject.name, revealProgress / 5);
                const spacedName = scrambledName.split('').join(' ');
                
                frame.innerHTML = `
                    <div class="subject-header" data-subject="${index}">
                        ${spacedName}
                    </div>
                    <div class="subject-body">
                        <div class="subject-slots" data-subject="${index}">
                            <div class="slot" data-slot="0">Drop fact here...</div>
                            <div class="slot" data-slot="1">Drop fact here...</div>
                            <div class="slot" data-slot="2">Drop fact here...</div>
                        </div>
                        <div class="subject-status" id="status${index}"></div>
                    </div>
                `;
                
                container.appendChild(frame);
                
                // Add drop listeners to slots (for desktop drag)
                const slots = frame.querySelectorAll('.slot');
                slots.forEach(slot => {
                    slot.addEventListener('dragover', handleDragOver);
                    slot.addEventListener('drop', handleDrop);
                    slot.addEventListener('dragleave', handleDragLeave);
                    
                    // Add click handler for mobile/desktop selection mode
                    slot.addEventListener('click', handleSlotClick);
                });
            });
        }
        
        function handleSlotClick(e) {
            const slot = e.currentTarget;
            
            // If no card is selected, do nothing
            if (!selectedCard) return;
            
            // If slot already has a card, move it back to the pile
            const existingDoc = slot.querySelector('.document');
            if (existingDoc) {
                returnCardToPile(existingDoc);
            }
            
            // Remove from old parent if it was in a slot
            if (selectedCard.parentElement.classList.contains('slot')) {
                selectedCard.parentElement.classList.remove('filled');
            }
            
            // Add selected card to this slot
            slot.innerHTML = '';
            slot.appendChild(selectedCard);
            slot.classList.add('filled');
            
            // Mark card as in-slot and deselect
            selectedCard.classList.add('in-slot');
            selectedCard.classList.remove('selected');
            selectedCard = null;
        }
        
        function scrambleText(text, revealPercent) {
            const revealCount = Math.floor(text.replace(/ /g, '').length * revealPercent);
            let nonSpaceIndex = 0;
            
            return text.split('').map((char) => {
                if (char === ' ') {
                    return '‚ñ™'; // Use a small block to show word gaps
                }
                const shouldReveal = nonSpaceIndex < revealCount;
                nonSpaceIndex++;
                return shouldReveal ? char : '‚ñà';
            }).join('');
        }
        
        function findDifferentiatingPosition(subjectA, subjectB) {
            // Find first position where subjects differ
            const cleanA = subjectA.replace(/ /g, '');
            const cleanB = subjectB.replace(/ /g, '');
            
            for (let i = 0; i < Math.min(cleanA.length, cleanB.length); i++) {
                if (cleanA[i] !== cleanB[i]) {
                    return i;
                }
            }
            return 0; // Default to first letter if somehow identical
        }
        
        function scrambleTextWithHint(text, revealPercent, hintPosition = null) {
            const revealCount = Math.floor(text.replace(/ /g, '').length * revealPercent);
            let nonSpaceIndex = 0;
            
            return text.split('').map((char) => {
                if (char === ' ') {
                    return '‚ñ™'; // Use a small block to show word gaps
                }
                const shouldReveal = nonSpaceIndex < revealCount || (hintPosition !== null && nonSpaceIndex === hintPosition);
                nonSpaceIndex++;
                return shouldReveal ? char : '‚ñà';
            }).join('');
        }
        
        function updateSubjectNames() {
            // Group subjects by letter count (excluding spaces)
            const subjectsByLength = {};
            currentPuzzle.subjects.forEach((subject, index) => {
                const length = subject.name.replace(/ /g, '').length;
                if (!subjectsByLength[length]) {
                    subjectsByLength[length] = [];
                }
                subjectsByLength[length].push({ subject, index });
            });
            
            // For each group with 2+ subjects, find differentiating positions
            const hintPositions = {};
            Object.values(subjectsByLength).forEach(group => {
                if (group.length >= 2) {
                    // Compare each pair and find where they differ
                    for (let i = 0; i < group.length; i++) {
                        for (let j = i + 1; j < group.length; j++) {
                            const diffPos = findDifferentiatingPosition(
                                group[i].subject.name,
                                group[j].subject.name
                            );
                            // Store the hint position for both subjects
                            hintPositions[group[i].index] = diffPos;
                            hintPositions[group[j].index] = diffPos;
                        }
                    }
                }
            });
            
            // Update each subject header with hints
            currentPuzzle.subjects.forEach((subject, index) => {
                const header = document.querySelector(`.subject-header[data-subject="${index}"]`);
                if (header) {
                    const hintPos = hintPositions[index];
                    const scrambledName = hintPos !== undefined 
                        ? scrambleTextWithHint(subject.name, revealProgress / 5, hintPos)
                        : scrambleText(subject.name, revealProgress / 5);
                    const spacedName = scrambledName.split('').join(' ');
                    header.textContent = spacedName;
                }
            });
        }
        
        function createDocument(text, answer, factId) {
            const doc = document.createElement('div');
            doc.className = 'document';
            doc.draggable = true;
            doc.dataset.answer = answer;
            doc.dataset.factId = factId;
            
            // Create text container
            const textSpan = document.createElement('span');
            textSpan.textContent = text;
            doc.appendChild(textSpan);
            
            // Create remove button
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-btn';
            removeBtn.textContent = '√ó';
            removeBtn.onclick = (e) => {
                e.stopPropagation();
                returnCardToPile(doc);
            };
            doc.appendChild(removeBtn);
            
            // Desktop drag
            doc.addEventListener('dragstart', handleDragStart);
            doc.addEventListener('dragend', handleDragEnd);
            
            // Mobile touch
            doc.addEventListener('touchstart', handleTouchStart, { passive: false });
            doc.addEventListener('touchmove', handleTouchMove, { passive: false });
            doc.addEventListener('touchend', handleTouchEnd);
            
            // Click/tap selection (works on both desktop and mobile)
            doc.addEventListener('click', handleCardClick);
            
            return doc;
        }
        
        function returnCardToPile(card) {
            // Remove from slot
            if (card.parentElement.classList.contains('slot')) {
                card.parentElement.classList.remove('filled');
            }
            
            // Remove in-slot class and deselect
            card.classList.remove('in-slot', 'selected');
            if (selectedCard === card) {
                selectedCard = null;
            }
            
            // Return to pile
            const pile = document.getElementById('documentsPile');
            pile.appendChild(card);
        }
        
        function handleCardClick(e) {
            e.stopPropagation();
            const card = e.currentTarget;
            
            // If card is in a slot and clicked, return it to pile
            if (card.parentElement.classList.contains('slot')) {
                returnCardToPile(card);
                return;
            }
            
            // If this card is already selected, deselect it
            if (selectedCard === card) {
                card.classList.remove('selected');
                selectedCard = null;
                return;
            }
            
            // Deselect any previously selected card
            if (selectedCard) {
                selectedCard.classList.remove('selected');
            }
            
            // Select this card
            card.classList.add('selected');
            selectedCard = card;
        }
        
        function handleDragStart(e) {
            draggedElement = e.target;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }
        
        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            draggedElement = null;
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }
        
        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }
        
        function handleDrop(e) {
            e.preventDefault();
            const slot = e.currentTarget;
            slot.classList.remove('drag-over');
            
            if (!draggedElement) return;
            
            // If slot already has a card, swap them
            const existingDoc = slot.querySelector('.document');
            if (existingDoc) {
                const pile = document.getElementById('documentsPile');
                pile.appendChild(existingDoc);
            }
            
            // Remove from old parent
            if (draggedElement.parentElement.classList.contains('slot')) {
                draggedElement.parentElement.classList.remove('filled');
            }
            
            // Add to new slot
            slot.innerHTML = '';
            slot.appendChild(draggedElement);
            slot.classList.add('filled');
        }
        
        // Touch handlers for mobile
        function handleTouchStart(e) {
            e.preventDefault();
            draggedElement = e.target;
            
            // Create visual clone
            touchClone = draggedElement.cloneNode(true);
            touchClone.style.position = 'fixed';
            touchClone.style.pointerEvents = 'none';
            touchClone.style.opacity = '0.8';
            touchClone.style.zIndex = '10000';
            document.body.appendChild(touchClone);
            
            const touch = e.touches[0];
            updateTouchClone(touch);
        }
        
        function handleTouchMove(e) {
            e.preventDefault();
            if (!touchClone) return;
            
            const touch = e.touches[0];
            updateTouchClone(touch);
        }
        
        function updateTouchClone(touch) {
            if (!touchClone) return;
            touchClone.style.left = (touch.clientX - touchClone.offsetWidth / 2) + 'px';
            touchClone.style.top = (touch.clientY - touchClone.offsetHeight / 2) + 'px';
        }
        
        function handleTouchEnd(e) {
            e.preventDefault();
            if (!draggedElement || !touchClone) return;
            
            const touch = e.changedTouches[0];
            const targetElement = document.elementFromPoint(touch.clientX, touch.clientY);
            const slot = targetElement?.closest('.slot');
            
            if (slot && !slot.classList.contains('filled')) {
                // Remove from old parent
                if (draggedElement.parentElement.classList.contains('slot')) {
                    draggedElement.parentElement.classList.remove('filled');
                }
                
                // Add to new slot
                slot.innerHTML = '';
                slot.appendChild(draggedElement);
                slot.classList.add('filled');
            }
            
            // Clean up
            if (touchClone && touchClone.parentElement) {
                touchClone.parentElement.removeChild(touchClone);
            }
            touchClone = null;
            draggedElement = null;
        }
        
        function checkAnswers() {
            if (checksRemaining <= 0) return;
            
            checksRemaining--;
            revealProgress++;
            
            // Update check icons
            const checkIcons = document.querySelectorAll('.check-icon');
            checkIcons[5 - checksRemaining - 1].classList.add('used');
            
            // Reveal more letters
            updateSubjectNames();
            
            // Check each subject
            let allCorrect = true;
            currentPuzzle.subjects.forEach((subject, subjectIndex) => {
                const slots = document.querySelectorAll(`.subject-slots[data-subject="${subjectIndex}"] .slot`);
                let correctCount = 0;
                
                slots.forEach(slot => {
                    const doc = slot.querySelector('.document');
                    if (doc && parseInt(doc.dataset.answer) === subjectIndex) {
                        correctCount++;
                    }
                });
                
                // Update status
                const status = document.getElementById(`status${subjectIndex}`);
                status.textContent = `${correctCount}/3 correct`;
                status.classList.add('show');
                
                if (correctCount === 3) {
                    status.classList.add('correct');
                } else {
                    status.classList.remove('correct');
                    allCorrect = false;
                }
            });
            
            // Check for victory
            if (allCorrect) {
                // Reveal all names
                revealProgress = 5;
                updateSubjectNames();
                
                // Launch confetti!
                launchConfetti();
                
                const resultBox = document.getElementById('resultBox');
                const resultText = document.getElementById('resultText');
                resultBox.className = 'result-box show victory';
                resultText.innerHTML = `
                    <div class="score">üéâ PERFECT! üéâ</div>
                    <div>ALL FACTS CORRECTLY SORTED!</div>
                    <div style="margin-top: 10px; font-size: 18px;">CHECKS USED: ${5 - checksRemaining}/5</div>
                `;
            } else if (checksRemaining === 0) {
                // Reveal all names when out of checks
                revealProgress = 5;
                updateSubjectNames();
                
                const resultBox = document.getElementById('resultBox');
                const resultText = document.getElementById('resultText');
                resultBox.className = 'result-box show';
                resultText.innerHTML = `
                    <div class="score" style="color: #ff0000;">OUT OF CHECKS!</div>
                    <div>Keep trying or see the solution:</div>
                    <button class="btn btn-reveal" id="revealBtn">REVEAL SOLUTION</button>
                `;
                
                // Add event listener to reveal button
                document.getElementById('revealBtn').addEventListener('click', revealSolution);
            }
        }
        
        function launchConfetti() {
            const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff', '#ffffff'];
            const confettiCount = 100;
            
            for (let i = 0; i < confettiCount; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + 'vw';
                    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDelay = Math.random() * 0.5 + 's';
                    confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                    document.body.appendChild(confetti);
                    
                    // Remove after animation
                    setTimeout(() => confetti.remove(), 4000);
                }, i * 30);
            }
        }
        
        function revealSolution() {
            // Move all cards to their correct positions
            currentPuzzle.subjects.forEach((subject, subjectIndex) => {
                subject.facts.forEach((fact, factIndex) => {
                    // Find the card with this fact
                    const allCards = document.querySelectorAll('.document');
                    allCards.forEach(card => {
                        if (card.textContent.trim().replace('√ó', '').trim() === fact.text) {
                            // Find the correct slot
                            const slot = document.querySelector(
                                `.subject-slots[data-subject="${subjectIndex}"] .slot[data-slot="${factIndex}"]`
                            );
                            
                            if (slot) {
                                // Clear slot if occupied
                                if (slot.classList.contains('filled')) {
                                    const existingCard = slot.querySelector('.document');
                                    if (existingCard) {
                                        returnCardToPile(existingCard);
                                    }
                                }
                                
                                // Place card in slot
                                slot.innerHTML = '';
                                slot.appendChild(card);
                                slot.classList.add('filled');
                                card.classList.add('in-slot');
                                card.classList.remove('selected');
                            }
                        }
                    });
                });
            });
            
            // Update all statuses to show correct
            currentPuzzle.subjects.forEach((subject, subjectIndex) => {
                const status = document.getElementById(`status${subjectIndex}`);
                status.textContent = `3/3 correct`;
                status.classList.add('show', 'correct');
            });
            
            // Update result box
            const resultBox = document.getElementById('resultBox');
            const resultText = document.getElementById('resultText');
            resultBox.className = 'result-box show';
            resultText.innerHTML = `
                <div class="score">SOLUTION REVEALED</div>
                <div>Now you know! Try the next puzzle to test yourself.</div>
            `;
        }
        
        function resetGame() {
            initGame(currentPuzzleIndex);
        }
        
        // Event listeners
        document.getElementById('checkBtn').addEventListener('click', checkAnswers);
        document.getElementById('resetBtn').addEventListener('click', resetGame);
        document.getElementById('debugCycle').addEventListener('click', () => {
            currentPuzzleIndex = (currentPuzzleIndex + 1) % puzzles.length;
            initGame(currentPuzzleIndex);
        });
        
        // Click on pile area to return selected card
        document.getElementById('documentsPile').addEventListener('click', (e) => {
            if (selectedCard && !e.target.classList.contains('document')) {
                returnCardToPile(selectedCard);
            }
        });
        
        // Deselect card when clicking outside
        document.addEventListener('click', (e) => {
            if (selectedCard && !e.target.closest('.document') && !e.target.closest('.slot')) {
                selectedCard.classList.remove('selected');
                selectedCard = null;
            }
        });
        
        // Initialize on load
        initGame();
    </script>
</body>
</html>
